<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relatório - SOTRIGO</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <header class="relatorio-header">
      <div class="header-left">
        <button onclick="voltarPortal()">
          <i class="fa-solid fa-arrow-left"></i> Voltar
        </button>
      </div>

      <h2 id="tituloRelatorio"></h2>

      <div class="header-right">
        <button
          id="btnFavoritar"
          onclick="toggleFavorito()"
          class="icon-button"
        >
          <i class="fa-solid fa-star"></i>
        </button>

        <button onclick="telaCheia()" class="icon-button">
          <i class="fa-solid fa-expand-arrows-alt"></i>
        </button>
      </div>
    </header>

    <iframe id="iframeRelatorio" src="" frameborder="0"></iframe>

    <div id="mascara-inferior"></div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const titulo = params.get("titulo");
      const url = params.get("url");
      const loggedInUser = localStorage.getItem("loggedInUser");
      const storageKey = `favoritos_${loggedInUser}`;

      document.getElementById("tituloRelatorio").textContent = titulo;
      document.getElementById("iframeRelatorio").src = url;

      function voltarPortal() {
        window.location.href = "portal.html";
      }

      // NOVO: Função para alternar o modo de Tela Cheia
      function telaCheia() {
        const elem = document.documentElement;

        // Verifica se já está em Tela Cheia
        const isFullscreen =
          document.fullscreenElement ||
          document.mozFullScreenElement ||
          document.webkitFullscreenElement ||
          document.msFullscreenElement;

        if (!isFullscreen) {
          // Ativa o modo de Tela Cheia
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
          } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
          }
        } else {
          // Sai do modo de Tela Cheia
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      }

      // NOVO: Função para lidar com a mudança de estado de Tela Cheia
      function handleFullscreenChange() {
        const isFullscreen =
          document.fullscreenElement ||
          document.mozFullScreenElement ||
          document.webkitFullscreenElement ||
          document.msFullscreenElement;
        const header = document.querySelector(".relatorio-header");
        const iframe = document.getElementById("iframeRelatorio");

        if (isFullscreen) {
          // Oculta o cabeçalho e expande o iframe para 100%
          header.style.display = "none";
          iframe.style.top = "0";
          iframe.style.height = "100vh";
        } else {
          // Restaura o cabeçalho e o layout padrão
          header.style.display = "flex";
          // Valor padrão (46px na versão desktop / 50px no mobile com CSS)
          iframe.style.top = "46px";
          iframe.style.height = "calc(100vh - 46px)";
        }
      }

      // NOVO: Adiciona os listeners de evento de Tela Cheia para garantir que o layout se ajuste
      document.addEventListener("fullscreenchange", handleFullscreenChange);
      document.addEventListener(
        "webkitfullscreenchange",
        handleFullscreenChange
      );
      document.addEventListener("mozfullscreenchange", handleFullscreenChange);
      document.addEventListener("MSFullscreenChange", handleFullscreenChange);

      function toggleFavorito() {
        let favoritos = JSON.parse(localStorage.getItem(storageKey) || "[]");
        const existe = favoritos.find((f) => f.titulo === titulo);

        if (existe) {
          favoritos = favoritos.filter((f) => f.titulo !== titulo);
          alert("Removido dos favoritos.");
        } else {
          favoritos.push({ titulo, url });
          alert("Adicionado aos favoritos!");
        }

        localStorage.setItem(storageKey, JSON.stringify(favoritos));
      }
    </script>
  </body>
</html>
