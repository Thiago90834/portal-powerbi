<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relatório - SOTRIGO</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link rel="stylesheet" href="style.css" />
    <style>
      /* Esta classe será adicionada dinamicamente pelo JS para forçar o Fullscreen no iOS */
      .fullscreen-active {
        overflow: hidden !important;
      }
      .fullscreen-active #iframeRelatorio {
        top: 0 !important;
        height: 100% !important;
        width: 100% !important;
        position: fixed !important;
        z-index: 9999 !important;
      }
      .fullscreen-active .relatorio-header {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <header class="relatorio-header">
      <div class="header-left">
        <button onclick="voltarPortal()">
          <i class="fa-solid fa-arrow-left"></i> Voltar
        </button>
      </div>

      <h2 id="tituloRelatorio"></h2>

      <div class="header-right">
        <button
          id="btnFavoritar"
          onclick="toggleFavorito()"
          class="icon-button"
        >
          <i class="fa-solid fa-star"></i>
        </button>

        <button onclick="telaCheia()" class="icon-button">
          <i class="fa-solid fa-expand-arrows-alt"></i>
        </button>
      </div>
    </header>

    <iframe id="iframeRelatorio" src="" frameborder="0"></iframe>

    <div id="mascara-inferior"></div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const titulo = params.get("titulo");
      const url = params.get("url");
      const loggedInUser = localStorage.getItem("loggedInUser");
      const storageKey = `favoritos_${loggedInUser}`;

      document.getElementById("tituloRelatorio").textContent = titulo;
      document.getElementById("iframeRelatorio").src = url;

      function voltarPortal() {
        window.location.href = "portal.html";
      }

      // NOVO: Define as alturas padrão com base no ambiente (Desktop ou Mobile)
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      const HEADER_HEIGHT_DEFAULT = isMobile ? "50px" : "46px";
      const IFRAME_HEIGHT_DEFAULT = `calc(100vh - ${HEADER_HEIGHT_DEFAULT})`;

      function telaCheia() {
        const elem = document.documentElement;

        // Verifica se já está em Tela Cheia
        const isFullscreen =
          document.fullscreenElement ||
          document.mozFullScreenElement ||
          document.webkitFullscreenElement ||
          document.msFullscreenElement ||
          document.body.classList.contains("fullscreen-active");

        if (!isFullscreen) {
          // 1. Tenta a API nativa
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
          } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
          }

          // 2. Se for iOS ou API falhar, força o modo CSS (handleFullscreenChange fará isso)
          if (!document.fullscreenEnabled && isMobile) {
            handleFullscreenChange(true);
          }
        } else {
          // 1. Tenta sair da API nativa
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }

          // 2. Se for iOS ou API falhar, força a saída do modo CSS
          if (
            !document.exitFullscreen &&
            document.body.classList.contains("fullscreen-active")
          ) {
            handleFullscreenChange(false);
          }
        }
      }

      // Função para lidar com a mudança de estado de Tela Cheia
      function handleFullscreenChange(forceState) {
        let isFullscreen =
          document.fullscreenElement ||
          document.mozFullScreenElement ||
          document.webkitFullscreenElement ||
          document.msFullscreenElement;

        // Se forceState for fornecido, usa ele para o estado
        if (typeof forceState !== "undefined") {
          isFullscreen = forceState;
        }

        const header = document.querySelector(".relatorio-header");
        const iframe = document.getElementById("iframeRelatorio");
        const body = document.body;

        if (isFullscreen) {
          // Aplica a classe Fullscreen-Active (usando !important no CSS embutido)
          body.classList.add("fullscreen-active");

          // Oculta a barra inferior do Power BI (opcional)
          document.getElementById("mascara-inferior").style.display = "none";
        } else {
          // Remove a classe Fullscreen-Active
          body.classList.remove("fullscreen-active");

          // Restaura as propriedades padrão do iframe e cabeçalho
          header.style.display = "flex";
          iframe.style.top = HEADER_HEIGHT_DEFAULT;
          iframe.style.height = IFRAME_HEIGHT_DEFAULT;
          iframe.style.position = "absolute";

          // Restaura a barra inferior do Power BI (opcional)
          document.getElementById("mascara-inferior").style.display = "block";

          // Hack para forçar a re-renderização (comum em iframes e Power BI)
          iframe.style.width = "99.9%";
          setTimeout(() => {
            iframe.style.width = "100%";
          }, 10);
        }
      }

      // Adiciona os listeners de evento de Tela Cheia
      document.addEventListener("fullscreenchange", handleFullscreenChange);
      document.addEventListener(
        "webkitfullscreenchange",
        handleFullscreenChange
      );
      document.addEventListener("mozfullscreenchange", handleFullscreenChange);
      document.addEventListener("MSFullscreenChange", handleFullscreenChange);

      function toggleFavorito() {
        let favoritos = JSON.parse(localStorage.getItem(storageKey) || "[]");
        const existe = favoritos.find((f) => f.titulo === titulo);

        if (existe) {
          favoritos = favoritos.filter((f) => f.titulo !== titulo);
          alert("Removido dos favoritos.");
        } else {
          favoritos.push({ titulo, url });
          alert("Adicionado aos favoritos!");
        }

        localStorage.setItem(storageKey, JSON.stringify(favoritos));
      }
    </script>
  </body>
</html>
